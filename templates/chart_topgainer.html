<!DOCTYPE html>
<html>
   <head>
       <title>Scale Stacking Chart</title>
       <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
       <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   </head>
   <body>
       <h1>Scale Stacking Chart</h1>
       <div>
           <label for="barCount">Number of Bars:</label>
           <select id="barCount" onchange="updateChart()">
               <option value="15" selected>15</option>
               <option value="10">10</option>
               <option value="5">5</option>
               <option value="all">All</option>
           </select>
       </div>
       <div>
           <canvas id="chart"></canvas>
       </div>

       <script>
           // Function to update the chart using AJAX
           function updateChart() {
               const barCount = document.getElementById('barCount').value;

               $.ajax({
                   url: "/filtered_oi_data",
                   type: "GET",
                   data: { bar_count: barCount },
                   dataType: "json",
                   success: function (response) {
                       const spotPrice = response.spot_price;
                       const closestPrices = response.closest_prices;
                       const callOI = response.calls_oi;
                       const putOI = response.puts_oi;

                       const labels = closestPrices.map(price => price.toString());

                       const data = {
                           labels: labels,
                           datasets: [
                               {
                                   label: 'Call OI',
                                   data: callOI,
                                   backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                   borderColor: 'rgba(75, 192, 192, 1)',
                                   borderWidth: 1
                               },
                               {
                                   label: 'Put OI',
                                   data: putOI,
                                   backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                   borderColor: 'rgba(255, 99, 132, 1)',
                                   borderWidth: 1
                               }
                           ]
                       };

                       const options = {
                           scales: {
                               x: {
                                   title: {
                                       display: true,
                                       text: 'Strike Prices'
                                   }
                               },
                               y: {
                                   title: {
                                       display: true,
                                       text: 'Call OI'
                                   }
                               }
                           }
                       };

                       const chartElement = document.getElementById('chart');
                       // Clear previous chart if exists
                       if (window.barChart !== undefined) {
                           window.barChart.destroy();
                       }
                       window.barChart = new Chart(chartElement, {
                           type: 'bar',
                           data: data,
                           options: options
                       });
                   }
               });
           }

           // Initial chart setup
           $(document).ready(function () {
               updateChart();
           });
       </script>
   </body>
</html>
