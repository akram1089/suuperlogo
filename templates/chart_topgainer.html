<!DOCTYPE html>
<html>
<head>
    <title>Option Data</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

</head>
<body>
    <h1>Option Data</h1>

    <label for="symbol-dropdown">Select Symbol:</label>
    <select id="symbol-dropdown">
        <option value="">--Select Symbol--</option>
    </select>

    <br>

    <label for="date-dropdown">Select Date:</label>
    <select id="date-dropdown">
        <option value="">--Select Date--</option>
    </select>

    <script>
        // Function to update the date dropdown
        function updateDateDropdown(selectedSymbol, prevSelectedDate) {
            var selectedDate = $('#date-dropdown').val(); // Get selected date
            if (prevSelectedDate) {
                selectedDate = prevSelectedDate;
            }
            $.ajax({
                url: '/fetch_option_data_with_spot_price', // Django URL for the view
                data: { symbol: selectedSymbol, selectedDate: selectedDate }, // Send selected symbol and date as parameters
                dataType: 'json',
                success: function (data) {
                    console.log(data)
                    var dateDropdown = $('#date-dropdown');
                    dateDropdown.empty(); // Clear the dropdown options

                    // Add the default option
                    dateDropdown.append($('<option>', {
                        value: '',
                        text: '--Select Date--'
                    }));

                    // Add the dates for the selected symbol
                    for (var i = 0; i < data.All_dates.length; i++) {
                        dateDropdown.append($('<option>', {
                            value: data.All_dates[i],
                            text: data.All_dates[i]
                        }));
                    }

                    // If there is a previously selected date in local storage, set it as the selected value
                    var prevSelectedDate = localStorage.getItem('selectedDate');
                    if (prevSelectedDate && data.All_dates.includes(prevSelectedDate)) {
                        dateDropdown.val(prevSelectedDate);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }

        $(document).ready(function () {
            // Function to populate the symbols dropdown
            function populateSymbolsDropdown() {
                $.ajax({
                    url: '/fetch_option_data_with_spot_price', // Django URL for the view
                    dataType: 'json',
                    success: function (data) {
                       
                        var symbolDropdown = $('#symbol-dropdown');
                        symbolDropdown.empty(); // Clear the dropdown options

                        // Add the default option
                        symbolDropdown.append($('<option>', {
                            value: '',
                            text: '--Select Symbol--'
                        }));

                        // Add the symbols
                        for (var i = 0; i < data.All_symbols.length; i++) {
                            symbolDropdown.append($('<option>', {
                                value: data.All_symbols[i],
                                text: data.All_symbols[i]
                            }));
                        }

                        // If there is a previously selected symbol in local storage, set it as the selected value
                        var prevSelectedSymbol = localStorage.getItem('selectedSymbol');
                        if (prevSelectedSymbol && data.All_symbols.includes(prevSelectedSymbol)) {
                            symbolDropdown.val(prevSelectedSymbol);
                        }

                        // Initially pass "nifty" as the selected symbol
                       
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }

            // Trigger the initial population of symbols dropdown
            populateSymbolsDropdown();

            // Event listener for symbol dropdown change
            $('#symbol-dropdown').change(function () {
                var selectedSymbol = $(this).val();

                // Clear the selected date from local storage when the symbol changes
                localStorage.removeItem('selectedDate');

                updateDateDropdown(selectedSymbol);
                // Save the selected symbol in local storage
                localStorage.setItem('selectedSymbol', selectedSymbol);
            });

            // Event listener for date dropdown change
            $('#date-dropdown').change(function () {
                var selectedSymbol = $('#symbol-dropdown').val();
                var selectedDate = $(this).val();

                // Save the selected date in local storage
                localStorage.setItem('selectedDate', selectedDate);

                updateDateDropdown(selectedSymbol, selectedDate);
            });
        });

        // Event listener for DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', function() {
            // Load the previously selected symbol and date from local storage and trigger the update
            var prevSelectedSymbol = localStorage.getItem('selectedSymbol');
            var prevSelectedDate = localStorage.getItem('selectedDate');

            if (prevSelectedSymbol) {
                $('#symbol-dropdown').val(prevSelectedSymbol);
                if (prevSelectedDate) {
                    $('#date-dropdown').val(prevSelectedDate);
                    updateDateDropdown(prevSelectedSymbol, prevSelectedDate);
                }
            } else {
                updateDateDropdown("nifty");
            }
        });
    </script>
</body>
</html>
